#!/bin/bash

echo "🔄 Basculement vers ngrok..."

# Lance ngrok
echo "🚀 Lancement de ngrok..."
gnome-terminal -- bash -c "ngrok start --all; exec bash" &
sleep 3

# Utilise les URLs fixes de ton ngrok.yml
BACKEND_URL="https://55ac64f26daf.ngrok-free.app"
FRONTEND_URL="https://e941202b4e92.ngrok-free.app"

# Backend Laravel .env
cat > .env << EOF
APP_NAME=Laravel
APP_ENV=local
APP_KEY=base64:ynfDMQLQuaX5zl2ne2Afor4tzKz/BQsUnRBJ5NNKvTw=
APP_DEBUG=true
APP_URL=$BACKEND_URL
FRONTEND_URL=$FRONTEND_URL

# Configuration SMS
SMS_API_URL=https://api.wirepick.com/httpsms/send
SMS_API_CLIENT=cppfsms
SMS_API_PASSWORD=API_Sapbd@Passer24
SMS_API_FROM=CPPF

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=cppf_e_services
DB_USERNAME=root
DB_PASSWORD=

# Email config
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=nguidjoldarryl@gmail.com
MAIL_PASSWORD=dsrxrpfdkfqmpkxc
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=nguidjoldarryl@gmail.com
MAIL_FROM_NAME="CPPF e-Services"

# Sanctum ngrok
SANCTUM_STATEFUL_DOMAINS=e941202b4e92.ngrok-free.app,55ac64f26daf.ngrok-free.app
SESSION_DRIVER=cookie
SESSION_DOMAIN=.ngrok-free.app

RECLAMATION_EMAIL=nguidjoldarryl@gmail.com
APP_RECLAMATION_EMAIL=nguidjoldarryl@gmail.com
EOF

# Frontend React .env
cd frontend # Adapte le chemin
cat > .env << EOF
REACT_APP_API_URL=$BACKEND_URL/api
EOF

echo "✅ Configuration ngrok appliquée!"
echo "🔧 Clearing Laravel cache..."
cd ..
php artisan config:clear
echo "🚀 Lance maintenant:"
echo "   Backend: php artisan serve"
echo "   Frontend: npm start"
echo "📱 Teste sur: $FRONTEND_URL"
echo "🔍 Interface ngrok: http://127.0.0.1:4040"